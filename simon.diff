Index: R4/nightly
===================================================================
--- R4/nightly	(revision 4799)
+++ R4/nightly	(working copy)
@@ -13,6 +13,8 @@
 # NOTE: packaging step re-signs all binaries and adds entitlements,
 #       so packaged version is not identical to the original build!
 
+set -e
+
 : ${BASE=/Volumes/Builds/R4}
 : ${RDIRS=`cat $BASE/builds`}
 
@@ -45,7 +47,7 @@
     JOBID=nightly-$$-`date +%s`
     export JOBID
 fi
-LOCKJOB=`cat "$BASE/LOCK" 2>/dev/null`
+LOCKJOB=`cat "$BASE/LOCK" 2>/dev/null || true`
 if [ -n "$LOCKJOB" -a "$LOCKJOB" != "$JOBID" ]; then
     echo "ERROR: build locked by $LOCKJOB (I am $JOBID)" >&2
     exit 1
Index: R4/packaging/build.sh
===================================================================
--- R4/packaging/build.sh	(revision 4799)
+++ R4/packaging/build.sh	(working copy)
@@ -1,5 +1,7 @@
 #!/bin/bash
 
+set -e
+
 : ${BASE=/Volumes/Builds/R4}
 
 PKGROOT="$BASE/packaging"
@@ -64,26 +66,26 @@
 
 echo " - Removing previous builds ..."
 rm -rf "$DST/R-fw" "$DST/R-app"
-mkdir "$DST/R-fw" "$DST/R-app"
+mkdir -p "$DST/R-fw" "$DST/R-app"
 rm -f "$PKGROOT/R-app.pkg" "$PKGROOT/R-fw.pkg" "$PKGROOT/R.pkg"
 
 echo " - Extracting R.app ..."
 tar fxz "$Rapp" -C "$DST/R-app"
 
-. "$BASE/unlock-sign"
+# . "$BASE/unlock-sign"
 
-echo " - Signing R.app ..."
-"$PKGROOT/R-sign-contents" "$DST/R-app" --force
-## after signing inside contents we also have to re-sign the entire app bundle
-codesign --force -o runtime --timestamp --entitlements "$BASE/R.entitlements" -s "Developer ID Application" "$DST/R-app/R.app"
+# echo " - Signing R.app ..."
+# "$PKGROOT/R-sign-contents" "$DST/R-app" --force
+# ## after signing inside contents we also have to re-sign the entire app bundle
+# codesign --force -o runtime --timestamp --entitlements "$BASE/R.entitlements" -s "Developer ID Application" "$DST/R-app/R.app"
 
-echo " - Checking R.app signature ..."
-if codesign -v "$DST/R-app/R.app"; then
-    echo "   OK"
-else
-    echo "** ERROR: $DST/R-app/R.app does not pass codesign validation" >&1
-    exit 1
-fi
+# echo " - Checking R.app signature ..."
+# if codesign -v "$DST/R-app/R.app"; then
+#     echo "   OK"
+# else
+#     echo "** ERROR: $DST/R-app/R.app does not pass codesign validation" >&1
+#     exit 1
+# fi
 
 echo " - Extracting R framework ..."
 tar fxz "$FWTAR" -C "$DST/R-fw"
@@ -90,8 +92,8 @@
 mv "$DST/R-fw/Library/Frameworks/R.framework" "$DST/R-fw/"
 rm -rf "$DST/R-fw/Library"
 
-echo " - Signing R framework ..."
-"$PKGROOT/R-sign-contents" "$DST/R-fw"
+# echo " - Signing R framework ..."
+# "$PKGROOT/R-sign-contents" "$DST/R-fw"
 
 GUIVER=`sed -n 's:.*<string>R .*GUI ::p' "$DST/R-app/R.app/Contents/Info.plist" | sed 's:[- ].*::' | head -n1`
 if [ -z "$GUIVER" ]; then
@@ -101,9 +103,9 @@
 export GUIVER
 echo "   Detected GUI version $GUIVER"
 
-echo " - Building R.app package ..."
-echo pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XARCH}.R.GUI.pkg --install-location /Applications --version "$GUIVER" --timestamp --root "$DST/R-app" --component-plist "$PKGROOT/R-app.plist" "$PKGROOT/R-app.pkg"
-pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XRACH}.R.GUI.pkg --install-location /Applications --version "$GUIVER" --timestamp --root "$DST/R-app" --component-plist "$PKGROOT/R-app.plist" "$PKGROOT/R-app.pkg"
+# echo " - Building R.app package ..."
+# echo pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XARCH}.R.GUI.pkg --install-location /Applications --version "$GUIVER" --timestamp --root "$DST/R-app" --component-plist "$PKGROOT/R-app.plist" "$PKGROOT/R-app.pkg"
+# pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XRACH}.R.GUI.pkg --install-location /Applications --version "$GUIVER" --timestamp --root "$DST/R-app" --component-plist "$PKGROOT/R-app.plist" "$PKGROOT/R-app.pkg"
 
 RVER0=`sed -n 's:.*R_MAJOR::p' < "$DST/R-fw/R.framework/Headers/Rversion.h" | sed 's:[^0-9.]*::g'`
 RVER1=`sed -n 's:.*R_MINOR::p' < "$DST/R-fw/R.framework/Headers/Rversion.h" | sed 's:[^0-9.]*::g'`
@@ -120,12 +122,12 @@
     exit 1
 fi
 
-echo " - Building R framework package for $VERFULL ..."
-echo pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XARCH}.R.fw.pkg --install-location /Library/Frameworks --version "$VER" --scripts "$PKGROOT/scripts-R-fw" --timestamp --root "$DST/R-fw" --component-plist "$PKGROOT/R-fw.plist" "$PKGROOT/R-fw.pkg"
-pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XARCH}.R.fw.pkg --install-location /Library/Frameworks --version "$VER" --scripts "$PKGROOT/scripts-R-fw" --timestamp --root "$DST/R-fw" --component-plist "$PKGROOT/R-fw.plist" "$PKGROOT/R-fw.pkg"
+# echo " - Building R framework package for $VERFULL ..."
+# echo pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XARCH}.R.fw.pkg --install-location /Library/Frameworks --version "$VER" --scripts "$PKGROOT/scripts-R-fw" --timestamp --root "$DST/R-fw" --component-plist "$PKGROOT/R-fw.plist" "$PKGROOT/R-fw.pkg"
+# pkgbuild --sign 'Developer ID Installer' --identifier org.R-project${XARCH}.R.fw.pkg --install-location /Library/Frameworks --version "$VER" --scripts "$PKGROOT/scripts-R-fw" --timestamp --root "$DST/R-fw" --component-plist "$PKGROOT/R-fw.plist" "$PKGROOT/R-fw.pkg"
 
 echo " - Creating distribution description ..."
 "$PKGROOT/mkres" "$PKGROOT"
 
 echo " - Building final bundle ..."
-productbuild --timestamp --product "$PKGROOT/req.plist" --resources "$PKGROOT/res" --sign 'Developer ID Installer' --distribution "$PKGROOT/dist.plist" --package-path "$PKGROOT" "$PKGROOT/$NAME.pkg" && cp -p "$PKGROOT/$NAME.pkg" "$BASE/deploy/$osname/$NAME/" && echo "R $VERFULL, GUI $GUIVER in $NAME.pkg" > "$BASE/deploy/$osname/$NAME/$NAME.pkg.SUCCESS" && echo "SUCCESS, a copy is in $BASE/deploy/$osname/$NAME/$NAME.pkg"
+productbuild --timestamp --product "$PKGROOT/req.plist" --resources "$PKGROOT/res" --distribution "$PKGROOT/dist.plist" --package-path "$PKGROOT" "$PKGROOT/$NAME.pkg" && cp -p "$PKGROOT/$NAME.pkg" "$BASE/deploy/$osname/$NAME/" && echo "R $VERFULL, GUI $GUIVER in $NAME.pkg" > "$BASE/deploy/$osname/$NAME/$NAME.pkg.SUCCESS" && echo "SUCCESS, a copy is in $BASE/deploy/$osname/$NAME/$NAME.pkg"
